<%- include('header') %>
<% var page = 'dashboard'; %>

<% if (!season) { %>
  <div class="card"><p>No active season. <a href="/admin">Create one</a>.</p></div>
<% } else { %>

  <h1 style="color:#fff; margin-bottom:20px;"><%= season.name %></h1>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="number"><%= stats.total_teams %></div>
      <div class="label">Teams</div>
    </div>
    <div class="stat-card">
      <div class="number"><%= stats.total_divisions %></div>
      <div class="label">Divisions</div>
    </div>
    <div class="stat-card">
      <div class="number"><%= stats.played_games %></div>
      <div class="label">Games Played</div>
    </div>
    <div class="stat-card">
      <div class="number"><%= stats.remaining_games %></div>
      <div class="label">Remaining</div>
    </div>
    <div class="stat-card">
      <div class="number"><%= stats.total_games %></div>
      <div class="label">Total Games</div>
    </div>
  </div>

  <div class="two-col">
    <div>
      <div class="card">
        <h3>Upcoming Games</h3>
        <% if (upcoming.length === 0) { %>
          <p style="color:#666;">No upcoming games.</p>
        <% } else { %>
          <table>
            <thead><tr><th>Date</th><th>Match</th><th>Division</th></tr></thead>
            <tbody>
            <% for (const g of upcoming) {
              const dateObj = new Date(g.match_day + 'T12:00:00');
              const dateStr = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
              const divNum = divisions.findIndex(d => d.name === g.division_name) + 1;
            %>
              <tr>
                <td><%= dateStr %></td>
                <td>
                  <span class="color-dot" style="background:<%= g.home_color %>"></span><%= g.home_name %>
                  <span style="color:#666;"> vs </span>
                  <span class="color-dot" style="background:<%= g.away_color %>"></span><%= g.away_name %>
                  <% if (g.is_playoff) { %><span class="playoff-marker">PLAYOFF</span><% } %>
                </td>
                <td><span class="div-badge div-<%= divNum %>">Div <%= divNum %></span></td>
              </tr>
            <% } %>
            </tbody>
          </table>
        <% } %>
      </div>

      <div class="card">
        <h3>Recent Results</h3>
        <% if (results.length === 0) { %>
          <p style="color:#666;">No results yet.</p>
        <% } else { %>
          <table>
            <thead><tr><th>Home</th><th>Score</th><th>Away</th></tr></thead>
            <tbody>
            <% for (const g of results) { %>
              <tr>
                <td><span class="color-dot" style="background:<%= g.home_color %>"></span><%= g.home_name %></td>
                <td style="font-weight:700; text-align:center;"><%= g.home_score %> - <%= g.away_score %></td>
                <td><span class="color-dot" style="background:<%= g.away_color %>"></span><%= g.away_name %></td>
              </tr>
            <% } %>
            </tbody>
          </table>
        <% } %>
      </div>
    </div>

    <div>
      <% for (const div of divisions) {
        const st = standingsByDiv[div.id] || [];
        const divNum = divisions.indexOf(div) + 1;
      %>
        <div class="card">
          <h3><span class="div-badge div-<%= divNum %>">Div <%= divNum %></span> <%= div.name %></h3>
          <table>
            <thead><tr><th>#</th><th>Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GD</th><th>Pts</th></tr></thead>
            <tbody>
            <% st.forEach((row, i) => { %>
              <tr>
                <td><%= i + 1 %></td>
                <td>
                  <span class="color-dot" style="background:<%= row.color_hex %>"></span>
                  <%= row.name %>
                  <% if (i < 4) { %><span class="qualify"> *</span><% } %>
                </td>
                <td><%= row.played %></td>
                <td><%= row.wins %></td>
                <td><%= row.draws %></td>
                <td><%= row.losses %></td>
                <td><%= row.goal_diff >= 0 ? '+' : '' %><%= row.goal_diff %></td>
                <td style="font-weight:700;"><%= row.points %></td>
              </tr>
            <% }); %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>
  </div>

<% } %>

<%- include('footer') %>
